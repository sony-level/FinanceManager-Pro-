name: Backend CI/CD - Test & Deploy to Google Cloud Run

on:
  push:
    branches: ["main"]
    paths:
      - "backend/**"
      - ".github/workflows/backend-ci-cd.yml"
  pull_request:
    branches: ["main"]
    paths:
      - "backend/**"

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: ${{ secrets.GCP_REGION }}
  SERVICE_NAME: ${{ secrets.GCP_SERVICE_NAME }}
  REGISTRY: ${{ secrets.GCP_REGION }}-docker.pkg.dev
  SERVICE_PORT: ${{ secrets.SERVICE_PORT }}

jobs:
  lint:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"          
          cache: "pip"
          cache-dependency-path: backend/requirements.txt

      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Check Black formatting
        run: black --check --diff .

      - name: Check isort imports
        run: isort --check-only --diff .

  auto-format:
    name: Auto Format & Create PR
    runs-on: ubuntu-latest
    needs: lint
    if: always() && needs.lint.result == 'failure'
    defaults:
      run:
        working-directory: backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.WORK_GITHUB_TOKEN }}
          ref: ${{ github.ref }}
      

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
      

      - name: Install formatting tools
        run: |
          python -m pip install --upgrade pip
          pip install ruff black isort

      - name: Run formatters
        run: |
          ruff check . --fix || true
          black .
          isort .

      - name: Check for changes
        id: changes
        run: |
          cd ..
          git diff --quiet && echo "changed=false" >> $GITHUB_OUTPUT || echo "changed=true" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.WORK_GITHUB_TOKEN }}
          commit-message: "style: auto-format code with ruff, black, isort"
          title: "Auto-format: Code style fixes"
          body: |
            ## Automatic Code Formatting

            This PR was automatically created by the CI/CD pipeline.

            **Changes applied:**
            - Ruff linting fixes
            - Black code formatting
            - isort import sorting

            Please review and merge if the changes look correct.
          branch: auto-format/style-fixes
          delete-branch: true
          labels: |
            automated
            style
            auto-merge

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: lint
    defaults:
      run:
        working-directory: backend

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
          DATABASE_SSL_REQUIRE: "false"
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/test_db?sslmode=disable
      DATABASE_SSL_REQUIRE: "false"

      DJANGO_SETTINGS_MODULE: config.settings
      SECRET_KEY: test-secret-key-for-ci
      DEBUG: "False"
      ALLOWED_HOSTS: "*"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-django coverage

      - name: Run migrations
        run: python manage.py migrate --run-syncdb

      - name: Run tests
        run: |
          python manage.py test --verbosity=2

      - name: Run tests with coverage
        run: |
          coverage run --source='.' manage.py test
          coverage report --fail-under=50 || true
          coverage xml

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: backend/coverage.xml

  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    defaults:
      run:
        working-directory: backend

    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.REGISTRY }} --quiet

      - name: Extract metadata for Docker
        id: meta
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          IMAGE_TAG="${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/financemanager/${{ env.SERVICE_NAME }}:${SHORT_SHA}"
          echo "tags=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: Build Docker image
        run: |
          docker build -t ${{ steps.meta.outputs.tags }} .
          docker tag ${{ steps.meta.outputs.tags }} ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/financemanager/${{ env.SERVICE_NAME }}:latest

      - name: Push Docker image
        run: |
          docker push ${{ steps.meta.outputs.tags }}
          docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/financemanager/${{ env.SERVICE_NAME }}:latest

  deploy:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image ${{ needs.build.outputs.image_tag }} \
            --region ${{ env.REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --port ${{ env.SERVICE_PORT }} \
            --memory 512Mi \
            --cpu 1 \
            --min-instances 0 \
            --max-instances 10 \
            --set-env-vars "DEBUG=False" \
            --set-env-vars "ALLOWED_HOSTS=*" \
            --set-secrets "SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }}:latest" \
            --set-secrets "DATABASE_URL=${{ secrets.DATABASE_URL }}:latest" \
            --set-secrets "SUPABASE_URL=${{ secrets.SUPABASE_URL }}:latest" \
            --set-secrets "SUPABASE_KEY=${{ secrets.SUPABASE_KEY }}:latest" \
            --set-secrets "SUPABASE_JWT_SECRET=${{ secrets.SUPABASE_JWT_SECRET }}:latest"

      - name: Get Cloud Run URL
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region ${{ env.REGION }} \
            --format 'value(status.url)')
          echo "Deployed to: ${SERVICE_URL}"
          echo "SERVICE_URL=${SERVICE_URL}" >> $GITHUB_ENV

      - name: Health check
        run: |
          echo "Waiting for service to be ready..."
          sleep 10
          curl -f "${SERVICE_URL}/api/v1/health/" || echo "Health check endpoint not available"

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [lint, test, build, deploy]
    if: always() && github.event_name == 'push'

    steps:
      - name: Deployment Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | ${{ needs.deploy.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY

 